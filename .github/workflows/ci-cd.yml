name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install flake8 black isort
      
      - name: Run Black (Code Formatter Check)
        run: |
          black --check --diff . || echo "Black formatting check completed"
      
      - name: Run isort (Import Sorting Check)
        run: |
          isort --check-only --diff . || echo "isort check completed"
      
      - name: Run Flake8 (Linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests with pytest
        run: |
          if [ -d tests ]; then
            pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
          else
            echo "No tests directory found, skipping tests"
          fi
      
      - name: Upload coverage reports
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: Run Safety (Dependency Security Check)
        run: |
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --output text || echo "Safety check completed with warnings"
          else
            echo "No requirements.txt found"
          fi
      
      - name: Run Bandit (Security Linter)
        run: |
          bandit -r . -f json -o bandit-report.json -x ./tests,./venv,./.venv || echo "Bandit scan completed"
          if [ -f bandit-report.json ]; then
            cat bandit-report.json
          fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'pull_request'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Deploy to Staging
        id: deploy
        run: |
          echo "Deploying to staging environment..."
          # Add your staging deployment commands here
          # Examples:
          # - Deploy to AWS, Azure, GCP
          # - Deploy to Heroku, Render, Railway
          # - Deploy to Kubernetes cluster
          # - Run database migrations
          echo "url=https://staging.example.com" >> $GITHUB_OUTPUT
          echo "Staging deployment completed successfully"
      
      - name: Run Smoke Tests on Staging
        run: |
          echo "Running smoke tests on staging environment..."
          # Add staging smoke tests here
          # Examples:
          # - curl health check endpoints
          # - Run integration tests against staging
          # - Verify database connections
          echo "Smoke tests passed"
      
      - name: Comment PR with Staging URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Deployed to staging! Check it out at: ${{ steps.deploy.outputs.url }}'
            })

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests pytest-asyncio
      
      - name: Run Integration Tests
        run: |
          echo "Running integration tests against staging environment..."
          # Add integration test commands here
          # Examples:
          # - pytest tests/integration/
          # - Run API endpoint tests
          # - Test authentication flows
          # - Test database operations
          echo "Integration tests passed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://production.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Deploy to Production
        run: |
          echo "Deploying to production environment..."
          # Add your production deployment commands here
          # Examples:
          # - Deploy to production servers
          # - Update load balancers
          # - Run production migrations
          # - Clear caches
          echo "Production deployment completed successfully"
      
      - name: Run Production Smoke Tests
        run: |
          echo "Running smoke tests on production environment..."
          # Add production smoke tests here
          echo "Production smoke tests passed"
      
      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            // Create a simple issue comment notification instead
            const message = `âœ… **Production Deployment Successful**\n\nCommit: ${context.sha}\nBranch: ${context.ref}\nDeployed at: ${new Date().toISOString()}\n\nProduction URL: https://production.example.com`;
            
            // Find the most recent merged PR for this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });
            
            if (prs.length > 0) {
              // Comment on the PR that was merged
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                body: message
              });
            }
            
            console.log('Production deployment notification sent')
